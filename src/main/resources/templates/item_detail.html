<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<title th:text="${item.name} + ' - 商品詳細'">商品詳細</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
	<div class="container">

		<!-- ========================= -->
		<!-- 商品名 -->
		<!-- ========================= -->
		<h1 th:text="${item.name}">商品名</h1>

		<!-- ========================= -->
		<!-- メッセージ -->
		<!-- ========================= -->
		<div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>
		<div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>

		<!-- ★ チャット送信不可などのメッセージ（ChatControllerで model.addAttribute("chatError", ...)） -->
		<div th:if="${chatError}" class="error-message" th:text="${chatError}"></div>

		<!-- ========================= -->
		<!-- 商品詳細 -->
		<!-- ========================= -->
		<div class="item-detail">

			<!-- 商品画像（複数） -->
			<div class="item-images">
				<img th:if="${item.imageUrl}" th:src="${item.imageUrl}" class="item-image">
				<img th:if="${item.imageUrl2}" th:src="${item.imageUrl2}" class="item-image">
				<img th:if="${item.imageUrl3}" th:src="${item.imageUrl3}" class="item-image">
				<img th:if="${item.imageUrl4}" th:src="${item.imageUrl4}" class="item-image">
				<img th:if="${item.imageUrl5}" th:src="${item.imageUrl5}" class="item-image">
				<img th:if="${item.imageUrl6}" th:src="${item.imageUrl6}" class="item-image">
				<img th:if="${item.imageUrl7}" th:src="${item.imageUrl7}" class="item-image">
				<img th:if="${item.imageUrl8}" th:src="${item.imageUrl8}" class="item-image">
			</div>

			<!-- 画像が1枚もない場合 -->
			<img th:if="${item.imageUrl == null}" th:src="@{/images/placeholder.png}" class="item-image">

			<!-- 価格 -->
			<p class="price">
				価格：
				<span th:text="'¥' + ${#numbers.formatDecimal(item.price,0,'COMMA',0,'POINT')}"></span>
			</p>

			<!-- 説明 -->
			<p>
				説明：
				<span th:text="${item.description}"></span>
			</p>

			<!-- カテゴリ -->
			<p>
				カテゴリ：
				<span th:text="${item.category != null ? item.category.name : '未分類'}"></span>
			</p>

			<!-- 出品者 -->
			<p>
				出品者：
				<span th:text="${item.seller.name}"></span>
			</p>

			<!-- ステータス -->
			<p>
				ステータス：
				<span th:text="${item.status.label}"></span>
			</p>

			<!-- ========================= -->
			<!-- ★ カード情報（カテゴリが「カード」の時だけ表示） -->
			<!-- ========================= -->
			<div th:if="${item.category != null and item.category.name eq 'カード'}">

				<!-- cardInfo がある時 -->
				<div class="card-info-box" th:if="${item.cardInfo != null}">
					<h2>カード情報</h2>

					<p>
						カード名：
						<span th:text="${item.cardInfo.cardName}">カード名</span>
					</p>

					<p>
						レアリティ：
						<span th:text="${item.cardInfo.rarity != null ? item.cardInfo.rarity.label : '-'}">レアリティ</span>
					</p>

					<p>
						封入パック：
						<span th:text="${item.cardInfo.packName}">封入パック</span>
					</p>

					<p>
						状態：
						<span th:text="${item.cardInfo.condition != null ? item.cardInfo.condition.label : '-'}">状態</span>
					</p>

					<p>
						レギュレーション：
						<span th:text="${item.cardInfo.regulation != null ? item.cardInfo.regulation.label : '-'}">レギュレーション</span>
					</p>
				</div>

				<!-- cardInfo が無い時（カードカテゴリの時だけ表示） -->
				<div class="card-info-box" th:if="${item.cardInfo == null}">
					<h2>カード情報</h2>
					<p>カード情報が登録されていません。</p>
				</div>

			</div>

		</div>

		<!-- ========================= -->
		<!-- ボタン群 -->
		<!-- ========================= -->
		<div class="button-group">

			<!-- ========================= -->
			<!-- 購入ボタン（出品中 & 自分以外） -->
			<!-- ========================= -->
			<form sec:authorize="isAuthenticated()" th:if="${item.status.name() == 'SELLING' and !isOwner}"
				th:action="@{/orders/initiate}" method="post" onsubmit="return confirm('本当にこの商品を購入しますか？');">

				<input type="hidden" name="itemId" th:value="${item.id}">

				<!-- CSRF -->
				<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

				<button type="submit" class="button">
					購入する
				</button>
			</form>

			<!-- ========================= -->
			<!-- チャットリンク（購入済みの場合は非表示） -->
			<!-- ========================= -->
			<a th:if="${item.status.name() != 'SOLD'}"
			   th:href="@{/chat/{itemId}(itemId=${item.id})}"
			   class="button secondary">
				チャットで質問 / 交渉
			</a>

			<!-- 購入済みのときの案内（任意） -->
			<span th:if="${item.status.name() == 'SOLD'}" class="error-message">
				購入済みのため、チャットでの質問はできません。
			</span>

			<!-- ========================= -->
			<!-- お気に入り（自分以外 & 購入済みは不可なので非表示） -->
			<!-- ========================= -->
			<div sec:authorize="isAuthenticated()" th:if="${!isOwner and item.status.name() != 'SOLD'}">

				<form th:if="${isFavorited}" th:action="@{/items/{id}/unfavorite(id=${item.id})}" method="post"
					style="display:inline;">

					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

					<button type="submit" class="button danger">
						お気に入り解除
					</button>
				</form>

				<form th:unless="${isFavorited}" th:action="@{/items/{id}/favorite(id=${item.id})}" method="post"
					style="display:inline;">

					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

					<button type="submit" class="button">
						お気に入りに追加
					</button>
				</form>
			</div>

			<!-- ========================= -->
			<!-- ★ 出品者のみ：編集・削除 -->
			<!-- ========================= -->
			<div th:if="${isOwner}" style="display:inline;">

				<!-- 編集 -->
				<a th:href="@{/items/{id}/edit(id=${item.id})}" class="button primary">
					編集する
				</a>

				<!-- 削除 -->
				<form th:action="@{/items/{id}/delete(id=${item.id})}" method="post" style="display:inline;"
					onsubmit="return confirm('本当に削除しますか？');">

					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

					<button type="submit" class="button danger">
						削除する
					</button>
				</form>

			</div>
		</div>

		<!-- ========================= -->
		<!-- チャット一覧 -->
		<!-- ========================= -->
		<h2>チャット</h2>

		<div class="chat-box">
		  <div th:each="chat : ${chats}"
		       class="chat-message"
		       th:classappend="${isOwner
		         or (
		           #authentication != null
		           and chat.sender != null
		           and chat.sender.email != null
		           and chat.sender.email != #authentication.name
		         )
		         ? 'other-message' : 'my-message'}">

		    <span class="sender-name" th:text="${chat.sender != null ? chat.sender.name : '不明'}"></span>
		    <span class="message-time" th:text="${#temporals.format(chat.createdAt,'yyyy/MM/dd HH:mm')}"></span>
		    <p th:text="${chat.message}"></p>
		  </div>

		  <div th:if="${#lists.isEmpty(chats)}">
		    <p>まだチャットメッセージはありません。</p>
		  </div>
		</div>



		<!-- ========================= -->
		<!-- チャット送信（購入済みの場合は非表示） -->
		<!-- ========================= -->
		<form sec:authorize="isAuthenticated()"
			  th:if="${item.status.name() != 'SOLD'}"
			  th:action="@{/chat/{itemId}(itemId=${item.id})}"
			  method="post"
			  class="chat-form">

			<textarea name="message" placeholder="メッセージを入力してください" required></textarea>

			<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

			<button type="submit">
				送信
			</button>
		</form>

		<!-- 購入済みのときの案内（フォームの代わりに表示） -->
		<div sec:authorize="isAuthenticated()" th:if="${item.status.name() == 'SOLD'}" class="error-message">
			購入済みのため、メッセージは送信できません。
		</div>

		<!-- ========================= -->
		<!-- 戻る -->
		<!-- ========================= -->
		<div class="button-group">
			<a th:href="@{/items}" class="button secondary">
				商品一覧に戻る
			</a>
		</div>

	</div>
</body>

</html>
