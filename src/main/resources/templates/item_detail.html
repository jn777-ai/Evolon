<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<title th:text="${item.name} + ' - 商品詳細'">商品詳細</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
	<div class="container">

		<!-- 商品名 -->
		<h1 th:text="${item.name}">商品名</h1>

		<!-- メッセージ -->
		<div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>
		<div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>

		<!-- 商品詳細 -->
		<div class="item-detail">

			<!-- 商品画像 -->
			<img class="item-image" th:if="${item.imageUrl != null}" th:src="${item.imageUrl}" alt="商品画像">
			<img class="item-image" th:if="${item.imageUrl == null}" th:src="@{/images/placeholder.png}" alt="商品画像">

			<!-- 価格 -->
			<p class="price">
				価格：
				<span th:text="'¥' + ${#numbers.formatDecimal(item.price,0,'COMMA',0,'POINT')}"></span>
			</p>

			<!-- 説明 -->
			<p>説明：<span th:text="${item.description}"></span></p>

			<!-- カテゴリ -->
			<p>
				カテゴリ：
				<span th:text="${item.category != null ? item.category.name : '未分類'}"></span>
			</p>

			<!-- 出品者 -->
			<p>
				出品者：
				<span th:text="${item.seller.name}"></span>
				<span th:if="${sellerAverageRating}">
					（平均評価：
					<span th:text="${sellerAverageRating}"></span>）
				</span>
			</p>

			<!-- ステータス -->
			<p>ステータス：<span th:text="${item.status}"></span></p>

		</div>

		<!-- ボタン群 -->
		<div class="button-group">

			<!-- 購入ボタン -->
			<form sec:authorize="isAuthenticated()"
				th:if="${item.status != null and item.status.trim() == '出品中' and !isOwner}"
				th:action="@{/orders/initiate-purchase}" method="post" onsubmit="return confirm('本当にこの商品を購入しますか？');">
				<input type="hidden" name="itemId" th:value="${item.id}">
				<button type="submit" class="button">購入する</button>
			</form>

			<!-- チャット -->
			<a th:href="@{/chat/{itemId}(itemId=${item.id})}" class="button secondary">
				チャットで質問 / 交渉
			</a>

			<!-- お気に入り -->
			<div sec:authorize="isAuthenticated()" th:if="!(isOwner ?: false)">
				<form th:if="${isFavorited ?: false}" th:action="@{/items/{id}/unfavorite(id=${item.id})}" method="post"
					style="display:inline;">
					<button type="submit" class="button danger">お気に入り解除</button>
				</form>

				<form th:unless="${isFavorited ?: false}" th:action="@{/items/{id}/favorite(id=${item.id})}"
					method="post" style="display:inline;">
					<button type="submit" class="button">お気に入りに追加</button>
				</form>
			</div>
		</div>
	</div>

	<!-- チャット -->
	<h2>チャット</h2>

	<div class="chat-box">
	    <div th:each="chat : ${chatList}" th:if="${chat != null}">

	        <span class="sender-name"
	              th:text="${chat.sender != null ? chat.sender.name : '退会ユーザー'}">
	        </span>

	        <span class="message-time"
	              th:text="${chat.createdAt != null
	                ? #temporals.format(chat.createdAt,'yyyy/MM/dd HH:mm')
	                : ''}">
	        </span>

	        <p th:text="${chat.message}"></p>

	    </div>
	</div>



		<!-- チャット送信 -->
		<form sec:authorize="isAuthenticated()" th:action="@{/chat/{itemId}(itemId=${item.id})}" method="post"
			class="chat-form">

			<textarea name="message" placeholder="メッセージを入力してください" required></textarea>
			<button type="submit">送信</button>
		</form>

		<!-- 戻る -->
		<div class="button-group">
			<a th:href="@{/items}" class="button secondary">
				商品一覧に戻る
			</a>
		</div>

	</div>
</body>

</html>