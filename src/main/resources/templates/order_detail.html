<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>取引詳細</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
<div class="container">

    <h1>取引詳細</h1>

    <!-- ================= メッセージ（フラッシュ表示） ================= -->
    <div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>
    <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>

    <!-- ================= 商品情報 ================= -->
    <section class="card">
        <!-- ★ item は model に無いので order 経由 -->
        <h2 th:text="${order.item.name}">商品名</h2>

        <p>
            価格：
            <span th:text="'¥' + ${#numbers.formatDecimal(order.price,0,'COMMA',0,'POINT')}"></span>
        </p>

        <p>
            ステータス：
            <strong th:text="${order.orderStatus.label}"></strong>
        </p>
    </section>

    <!-- ================= 出品者：発送 ================= -->
    <section th:if="${canShip}">
        <form th:action="@{/orders/{id}/ship(id=${order.id})}" method="post">
            <!-- CSRF -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button class="button">発送済みにする</button>
        </form>
    </section>

    <!-- ================= 購入者：到着確認 ================= -->
    <section th:if="${canDeliver}">
        <form th:action="@{/orders/{id}/deliver(id=${order.id})}" method="post">
            <!-- CSRF -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button class="button">到着確認</button>
        </form>
    </section>

    <!-- ================= 取引メッセージ ================= -->
    <section class="card">
        <h2>取引メッセージ</h2>

        <div class="chat-box">

            <!-- ★ chats ではなく orderMessages を表示する -->
            <div th:each="m : ${orderMessages}" class="chat-message">
                <strong th:text="${m.sender.name}">送信者</strong>：
                <span th:text="${m.message}">本文</span>

                <!-- ★ 表示形式はお好みで。まずは年月日まで出すとズレ確認が楽 -->
                <small th:text="${#temporals.format(m.createdAt,'yyyy/MM/dd HH:mm')}">時刻</small>
            </div>

            <p th:if="${#lists.isEmpty(orderMessages)}">まだメッセージはありません</p>
        </div>

        <form th:action="@{/orders/{id}/chat(id=${order.id})}" method="post">
            <textarea name="message" required></textarea>

            <!-- CSRF -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

            <button class="button">送信</button>
        </form>
    </section>

    <!-- ================= 購入者の評価 ================= -->
    <section th:if="${canBuyerReview}" class="card">
        <h2>出品者を評価する</h2>

        <form th:action="@{/orders/{id}/review(id=${order.id})}" method="post">
            <!-- CSRF -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

            <select name="result" required>
                <option value="GOOD">良い</option>
                <option value="BAD">悪い</option>
            </select>

            <textarea name="comment" placeholder="コメントを入力" required></textarea>
            <button class="button">評価する</button>
        </form>
    </section>

    <!-- ================= 出品者の評価 ================= -->
    <section th:if="${canSellerReview}" class="card">
        <h2>購入者を評価する</h2>

        <form th:action="@{/orders/{id}/review(id=${order.id})}" method="post">
            <!-- CSRF -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

            <select name="result" required>
                <option value="GOOD">良い</option>
                <option value="BAD">悪い</option>
            </select>

            <textarea name="comment" placeholder="コメントを入力" required></textarea>
            <button class="button">評価する</button>
        </form>
    </section>

    <!-- ================= 完了 ================= -->
    <section th:if="${!canBuyerReview and !canSellerReview and order.orderStatus.name() == 'COMPLETED'}">
        <p class="success">この取引は完了しました</p>
    </section>

    <div class="button-group">
        <a th:href="@{/my-page/orders}" class="button secondary">取引一覧に戻る</a>
    </div>

</div>
</body>
</html>
