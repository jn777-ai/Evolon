<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>商品一覧</title>

  <!-- 共通CSS -->
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
  <div class="container">

    <!-- ========================= -->
    <!-- ページタイトル -->
    <!-- ========================= -->
    <h1>商品一覧</h1>

    <!-- ========================= -->
    <!-- ナビゲーション -->
    <!-- ========================= -->
    <div class="main-nav">
      <a th:href="@{/items/new}" class="button">商品を出品</a>
      <a th:href="@{/my-page}" class="button">マイページ</a>

      <form th:action="@{/logout}" method="post" style="display:inline;">
        <button type="submit" class="button secondary">ログアウト</button>
      </form>
    </div>

    <!-- ========================= -->
    <!-- 検索ボタン（モーダル開く） -->
    <!-- ========================= -->
    <div class="search-head">
      <button type="button" class="button secondary" id="openSearch">
        🔍 絞り込み検索
      </button>

      <div class="search-hint">
        <span th:if="${param.cardName != null and param.cardName[0] != ''}">
          カード名: <b th:text="${param.cardName[0]}"></b>
        </span>
      </div>
    </div>

    <!-- ========================= -->
    <!-- 検索モーダル -->
    <!-- ========================= -->
    <div class="modal-backdrop" id="searchModal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-label="検索モーダル">
        <div class="modal-head">
          <h2 class="modal-title">絞り込み検索</h2>
          <button type="button" class="modal-close" id="closeSearch" aria-label="閉じる">×</button>
        </div>

        <!-- ========================= -->
        <!-- 検索フォーム -->
        <!-- ========================= -->
        <form th:action="@{/items/search}" method="get" class="filter-form modal-form">

          <div>
            <label>カード名</label>
            <input type="text" name="cardName" th:value="${param.cardName}">
          </div>

          <div>
            <label>レアリティ</label>
            <select name="rarity">
              <option value="">全て</option>
              <option th:each="r : ${rarities}"
                      th:value="${r.name()}"
                      th:text="${r.label}"
                      th:selected="${param.rarity != null and param.rarity[0] == r.name()}">
              </option>
            </select>
          </div>

          <div>
            <label>レギュレーション</label>
            <select name="regulation">
              <option value="">全て</option>
              <option th:each="r : ${regulations}"
                      th:value="${r.name()}"
                      th:text="${r.label}"
                      th:selected="${param.regulation != null and param.regulation[0] == r.name()}">
              </option>
            </select>
          </div>

          <div>
            <label>封入パック</label>
            <input type="text" name="packName" th:value="${param.packName}">
          </div>

          <div>
            <label>状態</label>
            <select name="condition">
              <option value="">全て</option>
              <option th:each="c : ${conditions}"
                      th:value="${c.name()}"
                      th:text="${c.label}"
                      th:selected="${param.condition != null and param.condition[0] == c.name()}">
              </option>
            </select>
          </div>

          <div>
            <label>価格</label>
            <div class="range">
              <input type="number" name="minPrice" placeholder="最小" th:value="${param.minPrice}">
              <span class="range-sep">〜</span>
              <input type="number" name="maxPrice" placeholder="最大" th:value="${param.maxPrice}">
            </div>
          </div>

          <div>
            <label>並び替え</label>
            <select name="sort">
              <option value="new" th:selected="${param.sort == null or param.sort[0] == 'new'}">新着順</option>
              <option value="priceAsc" th:selected="${param.sort != null and param.sort[0] == 'priceAsc'}">価格昇順</option>
              <option value="priceDesc" th:selected="${param.sort != null and param.sort[0] == 'priceDesc'}">価格降順</option>
            </select>
          </div>

          <div class="modal-actions">
            <a th:href="@{/items}" class="button secondary">リセット</a>
            <button type="submit" class="button">検索</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========================= -->
    <!-- 商品一覧 -->
    <!-- ========================= -->
    <div class="item-grid">

      <!-- 商品1件 -->		<div class="item-card"
		     th:each="item : ${items.content}"
		     th:classappend="' category-' + ${
		        item.category == null ? 'other' :
		        (item.category.name == 'カード' ? 'card' :
		        (item.category.name == 'サプライ' ? 'supply' :
		        (item.category.name == 'デッキ・構築済み' ? 'deck' : 'other')))
		     }">


        <a th:href="@{/items/{id}(id=${item.id})}">

          <!-- カテゴリバッジ -->
          <span class="type-badge"
                th:text="${item.category != null ? item.category.name : 'その他'}">
            カード
          </span>

          <!-- 画像 -->
          <img th:if="${item.imageUrl != null}" th:src="${item.imageUrl}" alt="商品画像">
          <img th:if="${item.imageUrl == null}" th:src="@{/images/placeholder.png}" alt="商品画像">

          <!-- 商品名 -->
          <h3 th:text="${item.name}"></h3>

          <!-- 価格 -->
          <p class="price"
             th:text="'¥' + ${#numbers.formatDecimal(item.price,0,'COMMA',0,'POINT')}">
          </p>

          <!-- ステータス（仮） -->
          <span class="status selling">出品中</span>
        </a>
      </div>

      <!-- 検索結果なし -->
      <div th:if="${items.totalElements == 0}">
        <p>商品が見つかりませんでした。</p>
      </div>
    </div>

    <!-- ========================= -->
    <!-- ページネーション（検索条件保持） -->
    <!-- ========================= -->
    <div class="pagination">

      <a th:if="${items.hasPrevious()}" th:href="@{/items/search(
            page=${items.number - 1},
            cardName=${param.cardName},
            rarity=${param.rarity},
            regulation=${param.regulation},
            condition=${param.condition},
            packName=${param.packName},
            minPrice=${param.minPrice},
            maxPrice=${param.maxPrice},
            sort=${param.sort}
          )}">
        前へ
      </a>

      <span th:each="i : ${#numbers.sequence(0, items.totalPages - 1)}">
        <a th:if="${i != items.number}" th:href="@{/items/search(
              page=${i},
              cardName=${param.cardName},
              rarity=${param.rarity},
              regulation=${param.regulation},
              condition=${param.condition},
              packName=${param.packName},
              minPrice=${param.minPrice},
              maxPrice=${param.maxPrice},
              sort=${param.sort}
            )}" th:text="${i + 1}">
        </a>

        <span th:if="${i == items.number}" class="current-page" th:text="${i + 1}"></span>
      </span>

      <a th:if="${items.hasNext()}" th:href="@{/items/search(
            page=${items.number + 1},
            cardName=${param.cardName},
            rarity=${param.rarity},
            regulation=${param.regulation},
            condition=${param.condition},
            packName=${param.packName},
            minPrice=${param.minPrice},
            maxPrice=${param.maxPrice},
            sort=${param.sort}
          )}">
        次へ
      </a>
    </div>

  </div>

  <!-- ========================= -->
  <!-- モーダル開閉JS -->
  <!-- ========================= -->
  <script>
    const modal = document.getElementById('searchModal');
    const openBtn = document.getElementById('openSearch');
    const closeBtn = document.getElementById('closeSearch');

    function openModal() {
      modal.classList.add('is-open');
      modal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-lock');
    }

    function closeModal() {
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('modal-lock');
    }

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);

    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });
  </script>

</body>
</html>
