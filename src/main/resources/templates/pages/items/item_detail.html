<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout/layout :: layout(
        title=${item != null ? item.name + ' - 商品詳細' : '商品詳細'},
        content=~{::content},
        showHeader=true,
        showFooter=true
      )}">

<th:block th:fragment="content">

  <!-- ========================= -->
  <!-- ツールバー -->
  <!-- ========================= -->
  <div class="toolbar">

    <div class="toolbar-left">
      <a th:href="@{/items/new}" class="button">商品を出品</a>
    </div>

    <div class="toolbar-right">
      <a th:href="@{/items}" class="button secondary">一覧へ戻る</a>
    </div>

  </div>

  <!-- ========================= -->
  <!-- 商品詳細 本体 -->
  <!-- ========================= -->
  <div class="container itemd">

    <!-- ===== ページ内ヘッダー ===== -->
    <header class="itemd-head">
      <div class="itemd-head__title">
        <h1 class="itemd-title" th:text="${item.name}">商品名</h1>

        <div class="itemd-meta">
          <span class="itemd-meta__label">出品者</span>
		  <span class="itemd-meta__value"
		        th:text="${(item.seller.nickname != null and !item.seller.nickname.isBlank())
		                   ? item.seller.nickname
		                   : item.seller.name}">
		    seller
		  </span>

          <span class="itemd-dot">•</span>
          <span class="status selling" th:text="${item.status.label}">出品中</span>
        </div>
      </div>

      <div class="itemd-head__msg">
        <div th:if="${errorMessage}" class="error-message itemd-msg" th:text="${errorMessage}"></div>
        <div th:if="${successMessage}" class="success-message itemd-msg" th:text="${successMessage}"></div>
        <div th:if="${chatError}" class="error-message itemd-msg" th:text="${chatError}"></div>
      </div>
    </header>

    <!-- ===== 2カラム ===== -->
    <div class="itemd-grid">

      <!-- ===== 左 ===== -->
      <main class="itemd-main">

        <!-- 画像 -->
        <section class="itemd-card itemd-media">

          <div class="itemd-viewer" data-gallery>
            <button type="button" class="itemd-nav itemd-nav--prev" aria-label="前の画像" data-prev>‹</button>
            <img class="itemd-mainimg" data-main alt="商品画像">
            <button type="button" class="itemd-nav itemd-nav--next" aria-label="次の画像" data-next>›</button>
          </div>

          <div class="itemd-srcs" data-srcs hidden>
            <img th:if="${item.imageUrl}"  th:src="${item.imageUrl}"  alt="">
            <img th:if="${item.imageUrl2}" th:src="${item.imageUrl2}" alt="">
            <img th:if="${item.imageUrl3}" th:src="${item.imageUrl3}" alt="">
            <img th:if="${item.imageUrl4}" th:src="${item.imageUrl4}" alt="">
            <img th:if="${item.imageUrl5}" th:src="${item.imageUrl5}" alt="">
            <img th:if="${item.imageUrl6}" th:src="${item.imageUrl6}" alt="">
            <img th:if="${item.imageUrl7}" th:src="${item.imageUrl7}" alt="">
            <img th:if="${item.imageUrl8}" th:src="${item.imageUrl8}" alt="">
          </div>

          <div class="itemd-thumbs" data-thumbs></div>

          <div class="itemd-nophoto" data-empty hidden>
            <img th:src="@{/images/placeholder.png}" class="itemd-mainimg" alt="no image">
          </div>
        </section>

        <!-- 概要 -->
        <section class="itemd-card">
          <h2 class="itemd-h2">概要</h2>

          <div class="itemd-kv">
            <div class="itemd-rows">
              <div class="itemd-row">
                <div class="itemd-row__label">カテゴリ</div>
                <div class="itemd-row__value"
                     th:text="${item.category != null ? item.category.name : '未分類'}">カテゴリ</div>
              </div>
              <div class="itemd-row">
                <div class="itemd-row__label">ステータス</div>
                <div class="itemd-row__value">
                  <span class="status selling" th:text="${item.status.label}">出品中</span>
                </div>
              </div>
            </div>
          </div>

          <div class="itemd-desc">
            <div class="itemd-desc__label">説明</div>
            <div class="itemd-desc__text" th:text="${item.description}">説明</div>
          </div>
        </section>

        <!-- 配送情報 -->
        <section class="itemd-card">
          <h2 class="itemd-h2">配送情報</h2>

          <div class="itemd-rows">
            <div class="itemd-row">
              <div class="itemd-row__label">発送までの日数</div>
              <div class="itemd-row__value"
                   th:text="${item.shippingDuration != null ? item.shippingDuration.label : '-'}">-</div>
            </div>
            <div class="itemd-row">
              <div class="itemd-row__label">送料負担</div>
              <div class="itemd-row__value"
                   th:text="${item.shippingFeeBurden != null ? item.shippingFeeBurden.label : '-'}">-</div>
            </div>
            <div class="itemd-row">
              <div class="itemd-row__label">発送元の地域</div>
              <div class="itemd-row__value"
                   th:text="${item.shippingRegion != null ? item.shippingRegion.label : '-'}">-</div>
            </div>
            <div class="itemd-row">
              <div class="itemd-row__label">配送方法</div>
              <div class="itemd-row__value"
                   th:text="${item.shippingMethod != null ? item.shippingMethod.label : '-'}">-</div>
            </div>
          </div>
        </section>

        <!-- カード情報 -->
        <section class="itemd-card" th:if="${item.category != null and item.category.name eq 'カード'}">
          <h2 class="itemd-h2">カード情報</h2>

          <div th:if="${item.cardInfo != null}" class="itemd-rows">
            <div class="itemd-row">
              <div class="itemd-row__label">カード名</div>
              <div class="itemd-row__value" th:text="${item.cardInfo.cardName}">-</div>
            </div>
            <div class="itemd-row">
              <div class="itemd-row__label">レアリティ</div>
              <div class="itemd-row__value"
                   th:text="${item.cardInfo.rarity != null ? item.cardInfo.rarity.label : '-'}">-</div>
            </div>
            <div class="itemd-row">
              <div class="itemd-row__label">封入パック</div>
              <div class="itemd-row__value" th:text="${item.cardInfo.packName}">-</div>
            </div>
            <div class="itemd-row">
              <div class="itemd-row__label">状態</div>
              <div class="itemd-row__value"
                   th:text="${item.cardInfo.condition != null ? item.cardInfo.condition.label : '-'}">-</div>
            </div>
            <div class="itemd-row">
              <div class="itemd-row__label">レギュレーション</div>
              <div class="itemd-row__value"
                   th:text="${item.cardInfo.regulation != null ? item.cardInfo.regulation.label : '-'}">-</div>
            </div>
          </div>

          <p th:if="${item.cardInfo == null}" class="muted">カード情報が登録されていません。</p>
        </section>

      </main>

      <!-- ===== 右 ===== -->
      <aside class="itemd-side">
        <div class="itemd-sidewrap">

          <!-- 購入 -->
          <section class="itemd-card itemd-sidecard">
            <div class="itemd-sideprice">
              <div class="itemd-sideprice__label">価格</div>
              <div class="itemd-sideprice__value"
                   th:text="'¥' + ${#numbers.formatDecimal(item.price,0,'COMMA',0,'POINT')}">¥0</div>
            </div>

            <div class="itemd-actions">

              <!-- ✅ プロフィール未完了：案内してプロフィール編集へ -->
              <div sec:authorize="isAuthenticated()"
                   th:if="${item.status.name() == 'SELLING' and !isOwner and !isProfileComplete}"
                   class="itemd-notice">
                <div class="itemd-notice__title">購入前にプロフィール入力が必要です</div>
                <div class="itemd-notice__text">氏名・住所が未入力のため、このまま購入できません。</div>

                <a th:href="@{/my-page/profile/edit(returnTo=${'/items/' + item.id})}"
                   class="button button--primary itemd-btn">
                  プロフィールを入力する
                </a>
              </div>

              <!-- ✅ プロフィール完了：通常の購入（JSが読めるdata付き） -->
              <form sec:authorize="isAuthenticated()"
                    th:if="${item.status.name() == 'SELLING' and !isOwner and isProfileComplete}"
                    th:action="@{/orders/initiate}" method="post"
                    class="js-buy-form"
                    th:attr="data-profile-ok=${isProfileComplete}">
                <input type="hidden" name="itemId" th:value="${item.id}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <button type="submit" class="button button--primary itemd-btn">購入する</button>
              </form>

              <!-- お気に入り -->
              <div sec:authorize="isAuthenticated()" th:if="${!isOwner and item.status.name() != 'SOLD'}">

                <form th:if="${isFavorited}" th:action="@{/items/{id}/unfavorite(id=${item.id})}" method="post">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                  <button type="submit" class="button button--danger itemd-btn">お気に入り解除</button>
                </form>

                <form th:unless="${isFavorited}" th:action="@{/items/{id}/favorite(id=${item.id})}" method="post">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                  <button type="submit" class="button button--outline itemd-btn">お気に入りに追加</button>
                </form>
              </div>


			  <!-- オーナー -->
			  <div th:if="${isOwner and item.status.name() == 'SELLING'}" class="itemd-edit-btn">
			    <a th:href="@{/items/{id}/edit(id=${item.id})}" class="itemd-edit-btn">
			      編集する
			    </a>
			  </div>


            </div>
          </section>
		  
		  <!-- 出品者の評価 -->
		  <section class="itemd-card itemd-reviewcard" th:if="${seller != null}">
		    <div class="panel-head">
		      <h2 class="panel-title">出品者の評価</h2>
		      <span class="chip"
		            th:text="${sellerReviewStats != null ? sellerReviewStats.reviewCount : 0} + '件'">0件</span>
		    </div>

		    <div th:if="${sellerReviewStats != null and sellerReviewStats.reviewCount > 0}" class="rating-row">
		      <div class="star-rating" th:style="'--rating:' + ${sellerReviewStats.avgRating}">
		        <span class="stars">★★★★★</span>
		        <span class="stars filled">★★★★★</span>
		      </div>

		      <div class="rating-score">
		        <span th:text="${#numbers.formatDecimal(sellerReviewStats.avgRating,1,1)}">5.0</span>
		        <span class="muted">/ 5.0</span>
		      </div>
		    </div>

		    <p th:if="${sellerReviewStats == null or sellerReviewStats.reviewCount == 0}" class="muted">
		      まだ評価はありません
		    </p>
		  </section>



          <!-- チャット -->
          <section class="itemd-card itemd-chatcard">
            <h2 class="itemd-h2 itemd-h2--chat">チャット</h2>

            <div class="itemd-chatbox" id="chatBox">
              <div th:if="${#lists.isEmpty(chats)}">
                <p class="muted">まだチャットメッセージはありません。</p>
              </div>

              <div th:each="chat : ${chats}"
                   th:with="
                     senderEmail=${chat.sender != null ? chat.sender.email : ''},
                     sellerEmail=${item.seller != null ? item.seller.email : ''},
                     loginEmail=${#authentication != null ? #authentication.name : ''},
                     isMe=${senderEmail != '' and senderEmail == loginEmail},
                     isSeller=${senderEmail != '' and senderEmail == sellerEmail}
                   "
                   class="itemd-chatmsg"
                   th:classappend="${isMe} ? ' is-me' : (${isSeller} ? ' is-seller' : ' is-other')">

                <div class="itemd-chatmeta">
					<span class="itemd-chatname"
					      th:text="${chat.sender != null
					        ? ((chat.sender.nickname != null and !#strings.isEmpty(chat.sender.nickname))
					            ? chat.sender.nickname
					            : chat.sender.name)
					        : '不明'}">名前</span>

                  <span class="itemd-chattime"
                        th:text="${#temporals.format(chat.createdAt,'yyyy/MM/dd HH:mm')}">time</span>
                </div>

                <p class="itemd-chattext" th:text="${chat.message}">本文</p>
              </div>
            </div>

            <form sec:authorize="isAuthenticated()"
                  th:if="${item.status.name() != 'SOLD'}"
                  th:action="@{/chat/{itemId}(itemId=${item.id})}"
                  method="post"
                  class="itemd-chatform">
              <textarea name="message" placeholder="メッセージを入力してください" required></textarea>
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
              <button type="submit" class="button button--primary itemd-btn">送信</button>
            </form>

            <div sec:authorize="isAuthenticated()"
                 th:if="${item.status.name() == 'SOLD'}"
                 class="error-message">
              購入済みのため、メッセージは送信できません。
            </div>
          </section>

        </div>
      </aside>

    </div>
  </div>

  <!-- JS：画像ギャラリー -->
  <script>
    (function () {
      const viewer = document.querySelector('[data-gallery]');
      if (!viewer) return;

      const mainImg = viewer.querySelector('[data-main]');
      const srcHost = document.querySelector('[data-srcs]');
      const thumbsHost = document.querySelector('[data-thumbs]');
      const emptyBlock = document.querySelector('[data-empty]');
      const btnPrev = viewer.querySelector('[data-prev]');
      const btnNext = viewer.querySelector('[data-next]');

      const srcs = Array.from(srcHost?.querySelectorAll('img') ?? [])
        .map(img => img.getAttribute('src'))
        .filter(Boolean);

      const unique = [];
      const seen = new Set();
      for (const s of srcs) {
        if (!seen.has(s)) { seen.add(s); unique.push(s); }
      }

      if (unique.length === 0) {
        if (emptyBlock) emptyBlock.hidden = false;
        return;
      }

      let index = 0;

      function render() {
        mainImg.src = unique[index];
        mainImg.alt = `商品画像 ${index + 1} / ${unique.length}`;

        btnPrev.classList.toggle('is-disabled', index === 0);
        btnNext.classList.toggle('is-disabled', index === unique.length - 1);

        thumbsHost.querySelectorAll('.itemd-thumb').forEach((t, i) => {
          t.classList.toggle('is-active', i === index);
        });
      }

      thumbsHost.innerHTML = '';
      unique.forEach((src, i) => {
        const t = document.createElement('img');
        t.src = src;
        t.alt = `サムネ ${i + 1}`;
        t.className = 'itemd-thumb';
        t.addEventListener('click', () => { index = i; render(); });
        thumbsHost.appendChild(t);
      });

      btnPrev.addEventListener('click', () => { if (index > 0) { index--; render(); } });
      btnNext.addEventListener('click', () => { if (index < unique.length - 1) { index++; render(); } });

      window.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') btnPrev.click();
        if (e.key === 'ArrowRight') btnNext.click();
      });

      render();
    })();

    // チャット：最新にスクロール
    (function(){
      const box = document.getElementById('chatBox');
      if (!box) return;
      box.scrollTop = box.scrollHeight;
    })();

    // ✅ 購入：プロフィール未入力なら案内（基本は上の分岐で出ないが、保険として残してOK）
    (function(){
      const form = document.querySelector('.js-buy-form');
      if (!form) return;

      const ok = (form.dataset.profileOk === 'true');

      form.addEventListener('submit', (e) => {
        if (!ok) {
          e.preventDefault();
          alert('購入手続きの前にプロフィール入力が必要です。');
        } else {
          const go = confirm('本当にこの商品を購入しますか？');
          if (!go) e.preventDefault();
        }
      });
    })();
  </script>

</th:block>
</html>
