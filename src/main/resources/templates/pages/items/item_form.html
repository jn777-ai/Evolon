<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/layout :: layout(
        title='Evolon-å•†å“å‡ºå“/ç·¨é›†',
        content=~{::content},
        showHeader=true,
        showFooter=true
      )}">

<th:block th:fragment="content">
<body>
<div class="container">
  <h1 th:text="${item.id == null ? 'å•†å“å‡ºå“' : 'å•†å“ç·¨é›†'}"></h1>

  <!-- ç·¨é›†åˆ¤å®šï¼ˆJSç”¨ï¼‰ -->
  <input type="hidden" id="isEdit" th:value="${item.id != null}">

  <!-- =========================
       æ›´æ–°/å‡ºå“ãƒ•ã‚©ãƒ¼ãƒ 
  ========================== -->
  <form th:action="${item.id == null ? '/items' : '/items/' + item.id}"
        method="post" enctype="multipart/form-data">

    <!-- ç·¨é›†æ™‚PUTï¼ˆHiddenHttpMethodFilterãŒæœ‰åŠ¹ãªã‚‰PUTæ‰±ã„ã«ãªã‚‹ï¼‰ -->
    <input type="hidden" th:if="${item.id != null}" name="_method" value="put">

    <!-- =========================
         åŸºæœ¬æƒ…å ±
    ========================== -->

    <p>
      <label for="name">å•†å“å:</label>
      <input type="text" id="name" name="name" th:value="${item.name}" required>
    </p>

    <p>
      <label for="categoryId">ã‚«ãƒ†ã‚´ãƒª:</label>
      <select id="categoryId" name="categoryId" required>
        <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
        <option th:each="category : ${categories}"
                th:value="${category.id}"
                th:text="${category.name}"
                th:selected="${item.category != null and item.category.id == category.id}">
        </option>
      </select>
    </p>

    <!-- =========================
         ç”»åƒï¼ˆå…¨ã‚«ãƒ†ã‚´ãƒªå…±é€šï¼‰
         â€»ã‚«ãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒª & æ–°è¦å‡ºå“ ã®ã¨ãã ã‘ 1æšç›®ã§OCR
    ========================== -->
    <div id="imageSection" style="margin-top:12px;">
      <p>
        <label for="images">å•†å“ç”»åƒ:</label>
        <input type="file" id="images" name="images" accept="image/*" multiple>
        <small>â€»æœ€å¤§8æšã¾ã§ï¼ˆã‚«ãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªæ™‚ã€æ–°è¦å‡ºå“ã¯1æšç›®ã‚’OCRã«ä½¿ç”¨ï¼‰</small>

        <span th:if="${item.imageUrl}">
          <br>ç¾åœ¨ã®ç”»åƒ:
          <img th:src="${item.imageUrl}" style="width:100px;">
        </span>
      </p>

      <!-- OCRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆã‚«ãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªæ™‚ã®ã¿ä½¿ã†ï¼‰ -->
      <p id="ocrStatus"
         style="display:none; color:#555; font-size:0.9em; margin-top:4px;"></p>

      <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div id="imagePreview"
           style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;"></div>
    </div>

    <!-- =========================
         ã‚«ãƒ¼ãƒ‰é–¢é€£ï¼ˆã‚«ãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªé¸æŠæ™‚ã®ã¿è¡¨ç¤ºï¼‰
         â€»å•†å“èª¬æ˜ã®ä¸Šã«ç½®ã
    ========================== -->
    <div id="cardSection" style="display:none; margin-top:18px;">
      <div id="cardFields">

        <p>
          <label for="cardNumberText">ã‚«ãƒ¼ãƒ‰ç•ªå·:</label>
          <input type="text" id="cardNumberText" placeholder="ä¾‹: sv8a 212/187">
          <button type="button" id="autoFillBtn">è‡ªå‹•å…¥åŠ›</button>
        </p>

        <p>
          <label for="cardName">ã‚«ãƒ¼ãƒ‰å:</label>
          <input type="text" id="cardName" name="cardInfo.cardName"
                 th:value="${item.cardInfo != null ? item.cardInfo.cardName : ''}">
        </p>

        <p>
          <label for="rarity">ãƒ¬ã‚¢ãƒªãƒ†ã‚£:</label>
          <select id="rarity" name="cardInfo.rarity">
            <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
            <option th:each="r : ${rarities}"
                    th:value="${r.name()}"
                    th:text="${r.label}"
                    th:selected="${item.cardInfo != null ? item.cardInfo.rarity == r : false}">
            </option>
          </select>
        </p>

        <p>
          <label for="packName">å°å…¥ãƒ‘ãƒƒã‚¯:</label>
          <input type="text" id="packName" name="cardInfo.packName"
                 th:value="${item.cardInfo != null ? item.cardInfo.packName : ''}">
        </p>

        <p>
          <label for="condition">çŠ¶æ…‹:</label>
          <select id="condition" name="cardInfo.condition">
            <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
            <option th:each="c : ${conditions}"
                    th:value="${c.name()}"
                    th:text="${c.label}"
                    th:selected="${item.cardInfo != null ? item.cardInfo.condition == c : false}">
            </option>
          </select>
        </p>

        <p>
          <label for="regulation">ãƒ¬ã‚®ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³:</label>
          <select id="regulation" name="cardInfo.regulation">
            <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
            <option th:each="r : ${regulations}"
                    th:value="${r.name()}"
                    th:text="${r.label}"
                    th:selected="${item.cardInfo != null ? item.cardInfo.regulation == r : false}">
            </option>
          </select>
        </p>
      </div>
    </div>

    <!-- =========================
         å•†å“èª¬æ˜ï¼ˆã‚«ãƒ¼ãƒ‰æƒ…å ±ã®ä¸‹ã«æ¥ã‚‹ï¼‰
    ========================== -->
    <p style="margin-top:14px;">
      <label for="description">å•†å“èª¬æ˜:</label>
      <textarea id="description" name="description"
                th:text="${item.description}"></textarea>
    </p>

    <!-- ä¾¡æ ¼ -->
    <p>
      <label for="price">ä¾¡æ ¼ (Â¥):</label>
      <input type="number" id="price" name="price"
             th:value="${item.price}" step="0.01" required>
    </p>

    <!-- =========================
         ç™ºé€æƒ…å ±
    ========================== -->
    <p>
      <label for="shippingDuration">ç™ºé€ã¾ã§ã®æ—¥æ•°:</label>
      <select id="shippingDuration" name="shippingDuration" required>
        <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
        <option th:each="d : ${shippingDurations}"
                th:value="${d.name()}"
                th:text="${d.label}"
                th:selected="${item.shippingDuration != null ? item.shippingDuration == d : false}">
        </option>
      </select>
    </p>

    <p>
      <label for="shippingFeeBurden">é€æ–™è² æ‹…:</label>
      <select id="shippingFeeBurden" name="shippingFeeBurden" required>
        <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
        <option th:each="b : ${shippingFeeBurdens}"
                th:value="${b.name()}"
                th:text="${b.label}"
                th:selected="${item.shippingFeeBurden != null ? item.shippingFeeBurden == b : false}">
        </option>
      </select>
    </p>

    <p>
      <label for="shippingRegion">ç™ºé€å…ƒã®åœ°åŸŸ:</label>
      <select id="shippingRegion" name="shippingRegion" required>
        <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
        <option th:each="r : ${shippingRegions}"
                th:value="${r.name()}"
                th:text="${r.label}"
                th:selected="${item.shippingRegion != null ? item.shippingRegion == r : false}">
        </option>
      </select>
    </p>

    <p>
      <label for="shippingMethod">é…é€æ–¹æ³•:</label>
      <select id="shippingMethod" name="shippingMethod" required>
        <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
        <option th:each="m : ${shippingMethods}"
                th:value="${m.name()}"
                th:text="${m.label}"
                th:selected="${item.shippingMethod != null ? item.shippingMethod == m : false}">
        </option>
      </select>
    </p>

    <!-- =========================
         ãƒœã‚¿ãƒ³
    ========================== -->
    <div class="button-group">

      <!-- âœ… å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆç·¨é›†æ™‚ã®ã¿ï¼‰ -->
      <button th:if="${item.id != null}"
              type="button"
              class="button danger"
              onclick="submitDelete();">
        å‰Šé™¤ã™ã‚‹
      </button>

      <div class="button-right">
        <button type="submit" class="button primary"
                th:text="${item.id == null ? 'å‡ºå“ã™ã‚‹' : 'æ›´æ–°ã™ã‚‹'}"></button>
        <a th:href="@{/items}" class="button secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
      </div>

    </div>
  </form>

  <!-- =========================
       âœ… å‰Šé™¤ç”¨ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆControllerã«åˆã‚ã›ã‚‹ï¼‰
       /items/{id}/delete ã« POST
  ========================== -->
  <form th:if="${item.id != null}"
        th:action="@{/items/{id}/delete(id=${item.id})}"
        method="post"
        id="deleteForm"
        style="display:none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
  </form>

</div>

<style>
/* OCRæˆåŠŸæ™‚ã«è»½ãå¼·èª¿ */
.ocr-highlight {
  background: #eaffea;
  transition: background 0.3s;
}
</style>

<script>
/* =========================
   âœ… å‰Šé™¤é€ä¿¡
========================= */
function submitDelete() {
  if (!confirm('æœ¬å½“ã«ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
  document.getElementById('deleteForm')?.submit();
}

/* =========================
   å…±é€š
========================= */
function isEditMode() {
  return document.getElementById('isEdit')?.value === 'true';
}
function isCardCategorySelected() {
  const categorySelect = document.getElementById('categoryId');
  const selectedText = categorySelect?.options[categorySelect.selectedIndex]?.text?.trim();
  return selectedText === 'ã‚«ãƒ¼ãƒ‰';
}
function showOcrStatus(msg) {
  const el = document.getElementById('ocrStatus');
  if (!el) return;
  el.style.display = 'block';
  el.textContent = msg;
}
function hideOcrStatus() {
  const el = document.getElementById('ocrStatus');
  if (!el) return;
  el.style.display = 'none';
  el.textContent = '';
}

/* =========================
   ã‚«ãƒ†ã‚´ãƒªåˆ‡æ›¿ï¼šã‚«ãƒ¼ãƒ‰æ¬„è¡¨ç¤º + required
   â€»ã‚«ãƒ¼ãƒ‰ä»¥å¤–ã§ã‚‚ç”»åƒã¯å¸¸ã«è¡¨ç¤ºï¼ˆUXè‰¯ã„ï¼‰
========================= */
function toggleCardUI() {
  const isCard = isCardCategorySelected();

  const cardSection = document.getElementById('cardSection');
  if (cardSection) cardSection.style.display = isCard ? 'block' : 'none';

  // OCRèª¬æ˜ï¼ˆã‚«ãƒ¼ãƒ‰Ã—æ–°è¦ã®ã¿ï¼‰
  if (isCard && !isEditMode()) {
    showOcrStatus('ğŸ“¸ å•†å“ç”»åƒã®1æšç›®ã‚’ã‚«ãƒ¼ãƒ‰æƒ…å ±ã®OCRèª­ã¿å–ã‚Šã«ä½¿ç”¨ã—ã¾ã™');
  } else {
    hideOcrStatus();
  }

  // requiredåˆ¶å¾¡
  ['cardName', 'packName', 'rarity', 'condition', 'regulation'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.required = isCard;

    if (!isCard) {
      if (el.tagName === 'SELECT') el.selectedIndex = 0;
      else el.value = '';
    }
  });

  const num = document.getElementById('cardNumberText');
  if (num && !isCard) num.value = '';
}

document.addEventListener('DOMContentLoaded', () => {
  toggleCardUI();
  document.getElementById('categoryId')?.addEventListener('change', toggleCardUI);
});

/* =========================
   ç”»åƒåˆ¶é™ + ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
========================= */
function validateImages(files, inputEl) {
  if (files.length > 8) {
    alert('ç”»åƒã¯æœ€å¤§8æšã¾ã§ã§ã™');
    inputEl.value = '';
    return false;
  }
  const total = files.reduce((sum, f) => sum + f.size, 0);
  if (total > 80 * 1024 * 1024) {
    alert('ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§80MBï¼‰');
    inputEl.value = '';
    return false;
  }
  return true;
}

function renderPreview(files) {
  const wrap = document.getElementById('imagePreview');
  if (!wrap) return;

  wrap.innerHTML = '';
  files.slice(0, 8).forEach((file, idx) => {
    const url = URL.createObjectURL(file);
    const img = document.createElement('img');
    img.src = url;
    img.alt = `preview-${idx}`;
    img.style.width = '84px';
    img.style.height = '84px';
    img.style.objectFit = 'cover';
    img.style.borderRadius = '10px';
    img.style.border = idx === 0 ? '2px solid #4aa3ff' : '1px solid #ddd';
    img.title = idx === 0 ? '1æšç›®ï¼ˆOCRã«ä½¿ç”¨ï¼‰' : '';
    wrap.appendChild(img);
  });
}

/* =========================
   OCRï¼ˆã‚«ãƒ¼ãƒ‰Ã—æ–°è¦ã®ã¿ï¼‰
========================= */
let lastOcrKey = null;

function highlightCardFields() {
  const ids = ['cardName', 'rarity', 'packName', 'regulation'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.add('ocr-highlight');
    setTimeout(() => el.classList.remove('ocr-highlight'), 900);
  });
}

async function doOcrAndFill(file) {
  if (!file) return;

  showOcrStatus('ğŸ“¸ ç”»åƒã‚’è§£æä¸­ã§ã™...');

  const formData = new FormData();
  formData.append('image', file);

  let res;
  try {
    res = await fetch('/api/ocr', { method: 'POST', body: formData });
  } catch (e) {
    showOcrStatus('âš ï¸ OCRãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰');
    return;
  }

  if (!res.ok) {
    showOcrStatus('âš ï¸ OCRã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒã‚¨ãƒ©ãƒ¼ï¼‰');
    return;
  }

  const data = await res.json();

  if (!data.card) {
    showOcrStatus('âš ï¸ ' + (data.message ?? 'ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'));
    return;
  }

  document.getElementById('cardName').value = data.card.cardName ?? '';
  document.getElementById('rarity').value = data.card.rarity ?? '';
  document.getElementById('packName').value = data.card.packName ?? '';
  document.getElementById('regulation').value = data.card.printedRegulation ?? '';

  showOcrStatus('âœ… è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã—ãŸï¼ˆå¿…è¦ãªã‚‰å¾®èª¿æ•´ã—ã¦ãã ã•ã„ï¼‰');
  highlightCardFields();
}

async function maybeOcrFirstImage(file) {
  const key = `${file.name}:${file.size}:${file.lastModified}`;
  if (key === lastOcrKey) return;
  lastOcrKey = key;
  await doOcrAndFill(file);
}

document.getElementById('images')?.addEventListener('change', async function () {
  const files = Array.from(this.files || []);
  if (!validateImages(files, this)) return;

  renderPreview(files);

  // ç·¨é›†ç”»é¢ã§ã¯OCRã—ãªã„ï¼ˆä¸Šæ›¸ãé˜²æ­¢ï¼‰
  if (isEditMode()) return;

  // ã‚«ãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªã®æ™‚ã ã‘OCRï¼ˆ1æšç›®ï¼‰
  if (!isCardCategorySelected()) return;

  await maybeOcrFirstImage(files[0]);
});

/* =========================
   æ‰‹å…¥åŠ›ï¼ˆã‚«ãƒ¼ãƒ‰ç•ªå·â†’è‡ªå‹•å…¥åŠ›ï¼‰
========================= */
document.getElementById('autoFillBtn')?.addEventListener('click', async () => {
  const text = document.getElementById('cardNumberText')?.value?.trim();
  if (!text) return alert('ã‚«ãƒ¼ãƒ‰ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

  const res = await fetch('/items/auto-fill?text=' + encodeURIComponent(text));
  if (!res.ok) return alert('è‡ªå‹•å…¥åŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ');

  const data = await res.json();
  if (!data) return alert('è©²å½“ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');

  document.getElementById('cardName').value = data.cardName ?? '';
  document.getElementById('packName').value = data.packName ?? '';
  document.getElementById('rarity').value = data.rarity ?? '';
  document.getElementById('regulation').value = data.regulation ?? '';

  showOcrStatus('âœ… æ‰‹å…¥åŠ›ã‹ã‚‰è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸ');
  highlightCardFields();
});
</script>

</body>
</th:block>
</html>
