<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/layout :: layout(
        title='Evolon-商品一覧',
        content=~{::content},
        showHeader=true,
        showFooter=true
      )}">

<th:block th:fragment="content">
<body>
<div class="container">
  <h1 th:text="${item.id == null ? '商品出品' : '商品編集'}"></h1>

  <!-- =========================
       更新/出品フォーム
  ========================== -->
  <form th:action="${item.id == null ? '/items' : '/items/' + item.id}"
        method="post" enctype="multipart/form-data">

    <input type="hidden" th:if="${item.id != null}" name="_method" value="put">

    <!-- =========================
         基本情報
    ========================== -->

    <!-- 商品名 -->
    <p>
      <label for="name">商品名:</label>
      <input type="text" id="name" name="name" th:value="${item.name}" required>
    </p>

    <!-- カテゴリ -->
    <p>
      <label for="categoryId">カテゴリ:</label>
      <select id="categoryId" name="categoryId" required>
        <option value="" disabled selected>選択してください</option>
        <option th:each="category : ${categories}"
                th:value="${category.id}"
                th:text="${category.name}"
                th:selected="${item.category != null and item.category.id == category.id}">
        </option>
      </select>
    </p>

    <!-- 商品説明 -->
    <p>
      <label for="description">商品説明:</label>
      <textarea id="description" name="description"
                th:text="${item.description}"></textarea>
    </p>

    <!-- 価格 -->
    <p>
      <label for="price">価格 (¥):</label>
      <input type="number" id="price" name="price"
             th:value="${item.price}" step="0.01" required>
    </p>

    <!-- =========================
         発送情報
    ========================== -->

    <p>
      <label for="shippingDuration">発送までの日数:</label>
      <select id="shippingDuration" name="shippingDuration" required>
        <option value="" selected>選択してください</option>
        <option th:each="d : ${shippingDurations}"
                th:value="${d.name()}"
                th:text="${d.label}"
                th:selected="${item.shippingDuration != null ? item.shippingDuration == d : false}">
        </option>
      </select>
    </p>

    <p>
      <label for="shippingFeeBurden">送料負担:</label>
      <select id="shippingFeeBurden" name="shippingFeeBurden" required>
        <option value="" selected>選択してください</option>
        <option th:each="b : ${shippingFeeBurdens}"
                th:value="${b.name()}"
                th:text="${b.label}"
                th:selected="${item.shippingFeeBurden != null ? item.shippingFeeBurden == b : false}">
        </option>
      </select>
    </p>

    <p>
      <label for="shippingRegion">発送元の地域:</label>
      <select id="shippingRegion" name="shippingRegion" required>
        <option value="" selected>選択してください</option>
        <option th:each="r : ${shippingRegions}"
                th:value="${r.name()}"
                th:text="${r.label}"
                th:selected="${item.shippingRegion != null ? item.shippingRegion == r : false}">
        </option>
      </select>
    </p>

    <p>
      <label for="shippingMethod">配送方法:</label>
      <select id="shippingMethod" name="shippingMethod" required>
        <option value="" selected>選択してください</option>
        <option th:each="m : ${shippingMethods}"
                th:value="${m.name()}"
                th:text="${m.label}"
                th:selected="${item.shippingMethod != null ? item.shippingMethod == m : false}">
        </option>
      </select>
    </p>

    <!-- =========================
         商品画像
    ========================== -->

    <p>
      <label for="images">商品画像:</label>
      <input type="file" id="images" name="images" accept="image/*" multiple>
      <small>※最大8枚まで</small>

      <!-- 編集時：既存画像表示 -->
      <span th:if="${item.imageUrl}">
        現在の画像:
        <img th:src="${item.imageUrl}" style="width:100px;">
      </span>
    </p>

    <!-- =========================
         カード関連（カード選択時のみ表示）
    ========================== -->

    <div id="cardSection" style="display:none;">

      <!-- OCR用画像 -->
      <p>
        <label for="cardImage">カード情報OCR用画像:</label>
        <input type="file" id="cardImage" accept="image/*">
      </p>

      <!-- カード情報 -->
      <div id="cardFields">
        <p>
          <label for="cardNumberText">カード番号:</label>
          <input type="text" id="cardNumberText" placeholder="例: sv8a 212/187">
          <button type="button" id="autoFillBtn">自動入力</button>
        </p>

        <p>
          <label for="cardName">カード名:</label>
          <input type="text" id="cardName" name="cardInfo.cardName"
                 th:value="${item.cardInfo != null ? item.cardInfo.cardName : ''}">
        </p>

        <p>
          <label for="rarity">レアリティ:</label>
          <select id="rarity" name="cardInfo.rarity">
            <option value="" selected>選択してください</option>
            <option th:each="r : ${rarities}"
                    th:value="${r.name()}"
                    th:text="${r.label}"
                    th:selected="${item.cardInfo != null ? item.cardInfo.rarity == r : false}">
            </option>
          </select>
        </p>

        <p>
          <label for="packName">封入パック:</label>
          <input type="text" id="packName" name="cardInfo.packName"
                 th:value="${item.cardInfo != null ? item.cardInfo.packName : ''}">
        </p>

        <p>
          <label for="condition">状態:</label>
          <select id="condition" name="cardInfo.condition">
            <option value="" selected>選択してください</option>
            <option th:each="c : ${conditions}"
                    th:value="${c.name()}"
                    th:text="${c.label}"
                    th:selected="${item.cardInfo != null ? item.cardInfo.condition == c : false}">
            </option>
          </select>
        </p>

        <p>
          <label for="regulation">レギュレーション:</label>
          <select id="regulation" name="cardInfo.regulation">
            <option value="" selected>選択してください</option>
            <option th:each="r : ${regulations}"
                    th:value="${r.name()}"
                    th:text="${r.label}"
                    th:selected="${item.cardInfo != null ? item.cardInfo.regulation == r : false}">
            </option>
          </select>
        </p>
      </div>
    </div>

    <!-- =========================
         ボタン
    ========================== -->
	<div class="button-group">

	  <!-- 左：削除（編集時のみ） -->
	  <button th:if="${item.id != null}"
	          type="submit"
	          class="button danger"
	          form="deleteForm"
	          onclick="return confirm('本当にこの商品を削除しますか？この操作は取り消せません。');">
	    削除する
	  </button>

	  <!-- 右：更新 → キャンセル -->
	  <div class="button-right">
	    <button type="submit" class="button primary"
	            th:text="${item.id == null ? '出品する' : '更新する'}"></button>
	    <a th:href="@{/items}" class="button secondary">キャンセル</a>
	  </div>

	</div>

  <!-- =========================
       削除用フォーム（外側formの外に置く）
       ※ form 入れ子禁止対策
  ========================== -->
  <form th:if="${item.id != null}"
        th:action="@{/items/{id}(id=${item.id})}"
        method="post"
        id="deleteForm"
        style="display:none;">
    <input type="hidden" name="_method" value="delete">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
  </form>

</div>

<script>
/* =========================
   削除ボタン送信
========================= */
function submitDelete() {
  if (!confirm('本当にこの商品を削除しますか？この操作は取り消せません。')) return;
  document.getElementById('deleteForm')?.submit();
}

/* =========================
   商品画像の制限
========================= */
document.getElementById('images')?.addEventListener('change', function () {
  const files = Array.from(this.files || []);
  if (files.length > 8) {
    alert('画像は最大8枚までです');
    this.value = '';
    return;
  }
  const total = files.reduce((sum, f) => sum + f.size, 0);
  if (total > 80 * 1024 * 1024) {
    alert('画像サイズが大きすぎます（最大80MB）');
    this.value = '';
  }
});

/* =========================
   カテゴリに応じてカード欄表示
========================= */
function toggleCardFields() {
  const categorySelect = document.getElementById('categoryId');
  const cardSection = document.getElementById('cardSection');
  if (!categorySelect || !cardSection) return;

  const selectedText =
    categorySelect.options[categorySelect.selectedIndex]?.text?.trim();

  const isCard = (selectedText === 'カード');

  cardSection.style.display = isCard ? 'block' : 'none';

  ['cardName', 'packName', 'rarity', 'condition', 'regulation']
    .forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.required = isCard;
      if (!isCard) el.value = '';
    });

  const cardImage = document.getElementById('cardImage');
  if (cardImage && !isCard) cardImage.value = '';
}

document.addEventListener('DOMContentLoaded', () => {
  toggleCardFields();
  document.getElementById('categoryId')
    ?.addEventListener('change', toggleCardFields);
});

/* =========================
   OCR処理
========================= */
async function doOcrAndFill(file) {
  if (!file) return;

  const formData = new FormData();
  formData.append('image', file);

  const res = await fetch('/api/ocr', { method: 'POST', body: formData });
  if (!res.ok) return;

  const data = await res.json();
  if (data.card) {
    document.getElementById('cardName').value = data.card.cardName ?? '';
    document.getElementById('rarity').value = data.card.rarity ?? '';
    document.getElementById('packName').value = data.card.packName ?? '';
    document.getElementById('regulation').value = data.card.printedRegulation ?? '';
  }
}

document.getElementById('cardImage')?.addEventListener('change', e => {
  const categorySelect = document.getElementById('categoryId');
  const text = categorySelect?.options[categorySelect.selectedIndex]?.text;
  if (text !== 'カード') return;

  doOcrAndFill(e.target.files?.[0]);
});

document.getElementById('autoFillBtn')?.addEventListener('click', async () => {
  const text = document.getElementById('cardNumberText')?.value?.trim();
  if (!text) return alert('カード番号を入力してください');

  const res = await fetch('/items/auto-fill?text=' + encodeURIComponent(text));
  if (!res.ok) return alert('自動入力に失敗しました');

  const data = await res.json();
  if (!data) return alert('該当カードが見つかりませんでした');

  document.getElementById('cardName').value = data.cardName ?? '';
  document.getElementById('packName').value = data.packName ?? '';
  document.getElementById('rarity').value = data.rarity ?? '';
  document.getElementById('regulation').value = data.regulation ?? '';
});
</script>
</body>
</th:block>
</html>
